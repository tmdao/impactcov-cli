# ImpactCov CLI (tia-cli)

A TypeScript CLI that powers test-impact analysis and coverage mapping.

## Features

- `init` — create a starter config
- `cover` — run tests with per-test coverage and cache a test↔files map
- `impacted` — compute impacted tests for a diff
- `run` — run only the impacted tests (fails open in CI)
- `report diff-coverage` — changed-lines coverage gate
- `upload` — upload build/coverage metadata to an API endpoint

> This repo is a scaffold with working stubs so you can iterate quickly.
> Commands aim to be side-effect-free unless explicitly running your test command.

## Cover: per-test coverage

The `cover` command runs your configured test framework and records, for each test, which files and line numbers were executed. Records are appended to `.impactcov/coverage-map.jsonl` one JSON object per line:

```json
{"testId":"Suite › test name","file":"/abs/path/to/file.ts","lines":[10,11,12]}
```

Supported frameworks:

- Mocha: Injects a require hook to instrument source via Istanbul, resets coverage before each test, and records on completion.
- Jest: Adds a setup file via `--setupFilesAfterEnv`, enables `--coverage`, and records per-test coverage based on Jest’s Istanbul counters.
- Vitest: Adds a setup file via `--setupFiles`, enables `--coverage`, and sets `--coverage.provider=istanbul` by default to ensure Istanbul counters are available.

Include/Exclude filtering:

- Uses glob patterns from `impactcov.config.json`:
  - `coverage.include`: files to include
  - `coverage.exclude`: files to exclude
- Matching uses `micromatch` against CWD-relative POSIX-style paths.
- For Mocha, exclude patterns also impact instrumentation; common test patterns and `node_modules` are always excluded from instrumentation.

Flags:

- `--no-coverage-filter`: Disables include/exclude filtering when recording per-test coverage. For Mocha, instrumentation filtering remains for test files and `node_modules`, but include/exclude globs are bypassed.
- `--coverage-provider <name>`: Vitest only. Overrides the coverage provider (`istanbul` or `v8`). Default is `istanbul`.
- `--strict-provider`: Vitest only. If the provider is not `istanbul`, the command exits early (code 3) and does not run tests.

Examples:

```bash
# Run with defaults (framework from config), recording per-test coverage
tia-cli cover

# Pass a test pattern through to your test runner
tia-cli cover "packages/app/src/**/*.test.ts"

# Disable include/exclude filtering for debugging
tia-cli cover --no-coverage-filter

# Vitest with v8 provider, warn and continue without per-test mapping
tia-cli cover --coverage-provider v8

# Vitest with v8 provider, but fail-fast if per-test mapping isn’t possible
tia-cli cover --coverage-provider v8 --strict-provider
```

## Impacted: compute impacted tests

The `impacted` command lists tests impacted by your changes. It relies on the per-test coverage map generated by `tia-cli cover` at `.impactcov/coverage-map.jsonl`.

Options (mirrored from CLI help):

- `--since <gitref>`: Base ref to diff against (defaults from config `impact.defaultSince`).
- `--files <list>`: Comma-separated changed files (bypasses git diff).
- `--json`: Emit machine-readable JSON.

Examples:

```bash
# Diff against origin/main
tia-cli impacted --since origin/main

# Use an explicit file list (CI artifact or precomputed list)
tia-cli impacted --files src/a.ts,src/b.ts

# Get JSON output for scripting
tia-cli impacted --since origin/main --json
```

Notes:

- If `--files` isn’t provided, changed files are computed from `git diff` to the base ref.
- The `--diff` option is reserved and not yet implemented.

## Run: execute only impacted tests

The `run` command executes only the tests impacted by your changes. If no impacted tests are found and fail-open is enabled, it runs all tests to keep CI green.

Options (mirrored from CLI help):

- `--since <gitref>`: Base ref to diff against (defaults from config).
- `--files <list>`: Comma-separated changed files.
- `--all-on-miss`: Fallback to run all tests when no impacted tests are found (default true; see config `impact.fallbackRunAll`).
- `--report <path>`: Write JSON summary report.

Examples:

```bash
tia-cli run --since origin/main
tia-cli run --files src/a.ts,src/b.ts
tia-cli run --since origin/main --report impactcov.json
```

Notes:

- Uses your configured test command from `impactcov.config.json`.
- The report includes `testsRun`, `durationMs`, and the base ref.

## Upload: send build/coverage metadata

The `upload` command sends build metadata and local artifacts (like `.impactcov/coverage-map.jsonl`) to a configured API endpoint.

Options (mirrored from CLI help):

- `--build <id>`: Build identifier (e.g., CI run ID).
- `--endpoint <url>`: API endpoint (overrides config `ci.endpoint`).
- `--token <token>`: Project token (overrides config `ci.projectToken`).

Examples:

```bash
tia-cli upload --build "$GITHUB_RUN_ID"
tia-cli upload --endpoint http://localhost:3000 --token dev-token
```

Notes:

- Writes a local report to `.impactcov/report.json` before attempting upload.
- If no endpoint is configured/provided, it skips upload and keeps the local report.
- Non-2xx responses set exit code 11.

## Quick start

> Package manager: This repo is configured for pnpm via the `packageManager` field. If pnpm isn't installed globally, use Corepack (bundled with Node 18+) to activate it:

```bash
# Enable Corepack once (may require sudo on some systems)
corepack enable

# Activate the version declared in package.json
corepack install
```

```bash
# Install deps
pnpm install  # or npm/yarn if you prefer

# Build (tsup bundles to dist/)
pnpm build

# Link CLI for local testing
pnpm link --global || npm link

# Show help
tia-cli --help
```

## Exit codes

- `0`: Success.
- `2`: Diff coverage check failed threshold (from `report diff-coverage`).
- `3`: Vitest provider mismatch in strict mode (`--strict-provider` with provider != `istanbul`).
- `11`: Upload failed (non-200 from API in `upload`).

## Config

Create `impactcov.config.json` in your repo root. Example:

```json
{
  "project": "webapp",
  "language": "javascript",
  "monorepo": false,
  "test": {
    "framework": "jest",
    "command": "npm test --",
    "testMatch": ["**/*.test.ts?(x)"]
  },
  "coverage": {
    "tool": "istanbul",
    "perTest": true,
    "include": ["src/**/*.{ts,tsx,js,jsx}"],
    "exclude": ["**/*.d.ts", "dist/**"]
  },
  "impact": {
    "defaultSince": "origin/main",
    "fallbackRunAll": true,
    "fileGranularity": "line",
    "diffCoverageThreshold": 85
  },
  "ci": {
    "provider": "github",
    "projectToken": "${IMPACTCOV_TOKEN}",
    "endpoint": "https://api.impactcov.dev"
  },
  "upload": {
    "enabled": true,
    "artifacts": [".impactcov/coverage-map.jsonl"]
  }
}
```

## GitHub Action (example)

```yaml
name: Impacted tests
on:
  pull_request:
jobs:
  impacted:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      - run: corepack enable
      - run: pnpm install --frozen-lockfile
      - run: pnpm build
      - name: Run impacted tests
        run: |
          node dist/index.js run --since origin/main --report impactcov.json || true
          node dist/index.js upload --build ${{ github.run_id }}
```

## CI example: cover → impacted → run → upload

Below is a compact workflow that records per-test coverage (to build the map), computes impacted tests, runs them, and uploads metadata. On main (or nightly), run `cover` to refresh the map; on PRs, you can skip `cover` if you cache artifacts across jobs.

```yaml
name: ImpactCov
on:
  push:
    branches: [ main ]
  pull_request:
jobs:
  test-impact:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      - run: corepack enable
      - run: pnpm install --frozen-lockfile
      - run: pnpm build

      # Build/refresh the per-test coverage map (recommended on main or nightly)
      - name: Record per-test coverage
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          node dist/index.js cover

      # List impacted tests for visibility (optional)
      - name: Impacted tests
        run: |
          node dist/index.js impacted --since origin/main --json | tee impacted.json

      # Run only impacted tests; fail-open to all tests if none are found
      - name: Run impacted
        run: |
          node dist/index.js run --since origin/main --report impactcov.json || true

      # Upload build/coverage metadata (requires endpoint/token configured)
      - name: Upload metadata
        env:
          IMPACTCOV_TOKEN: ${{ secrets.IMPACTCOV_TOKEN }}
        run: |
          node dist/index.js upload --build ${{ github.run_id }}
```
